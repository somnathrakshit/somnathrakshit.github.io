<!doctype html><html lang=en><head><title>Install cloudflared to set up secure Cloudflare Tunnels for free :: Somnath Rakshit</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I have been using Cloudflare Tunnels increasingly over the last year to securely enable my applications to be reached publicly without having to open firewall ports in my server. However, installing cloudflared and then setting up tunnels is not very straightforward. So, I wanted to develop this tutorial as a way to get tunnels up and running quickly. These steps are tested on Ubuntu 22.04.
Step 1: Install cloudflared Let us create env variables first."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/blog/install_cloudflared/><link rel=stylesheet href=/assets/style.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Install cloudflared to set up secure Cloudflare Tunnels for free"><meta property="og:description" content="I have been using Cloudflare Tunnels increasingly over the last year to securely enable my applications to be reached publicly without having to open firewall ports in my server. However, installing cloudflared and then setting up tunnels is not very straightforward. So, I wanted to develop this tutorial as a way to get tunnels up and running quickly. These steps are tested on Ubuntu 22.04.
Step 1: Install cloudflared Let us create env variables first."><meta property="og:url" content="/blog/install_cloudflared/"><meta property="og:site_name" content="Somnath Rakshit"><meta property="og:image" content="/img/favicon/orange.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-09-05 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Somnath Rakshit</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/blog>Blog</a></li><li><a href=/contact>Contact</a></li><li><a href=/projects>Projects</a></li><li><a href=/files/somnathrakshit_resume.pdf>Resume</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/blog>Blog</a></li><li><a href=/contact>Contact</a></li><li><a href=/projects>Projects</a></li><li><a href=/files/somnathrakshit_resume.pdf>Resume</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/blog/install_cloudflared/>Install cloudflared to set up secure Cloudflare Tunnels for free</a></h1><div class=post-meta><span class=post-date>2022-09-05</span></div><div class=post-content><div><p>I have been using Cloudflare Tunnels increasingly over the last year to securely enable my applications to be reached publicly without having to open firewall ports in my server. However, installing cloudflared and then setting up tunnels is not very straightforward. So, I wanted to develop this tutorial as a way to get tunnels up and running quickly. These steps are tested on Ubuntu 22.04.</p><h2 id=step-1-install-cloudflared>Step 1: Install cloudflared<a href=#step-1-install-cloudflared class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Let us create env variables first.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;tunnelname&#34;</span>
</span></span><span style=display:flex><span>HOSTNAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;subdomain.domain.tld&#34;</span>
</span></span></code></pre></div><p>Now, let us install cloudflared using their package. The commands below are specifically for Ubuntu 22.04. You can find instructions for other operating systems <a href=https://pkg.cloudflare.com/>here</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Add cloudflare gpg key</span>
</span></span><span style=display:flex><span>sudo mkdir -p --mode<span style=color:#f92672>=</span><span style=color:#ae81ff>0755</span> /usr/share/keyrings
</span></span><span style=display:flex><span>curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg &gt;/dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add this repo to your apt repositories</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared jammy main&#39;</span> | sudo tee /etc/apt/sources.list.d/cloudflared.list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># install cloudflared</span>
</span></span><span style=display:flex><span>sudo apt-get update <span style=color:#f92672>&amp;&amp;</span> sudo apt-get install cloudflared
</span></span></code></pre></div><p>This will install <code>cloudflared</code>.</p><h2 id=step-2-authenticate-cloudflared>Step 2: Authenticate cloudflared<a href=#step-2-authenticate-cloudflared class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Let us login and authenticate the cloudflared daemon to our account.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cloudflared login
</span></span></code></pre></div><p>Running the above command will launch the default browser window and prompt you to login to your Cloudflare account. Then, you will be prompted to select a site, which we have created previously. As soon as you have chosen your hostname, Cloudflare will download a certificate file to authenticate <code>cloudflared</code> with Cloudflare&rsquo;s network. Once authorization is completed successfully, your cert.pem will be download to the default directory. If you&rsquo;re running a headless server (no monitor or keyboard), you could copy the authentication URL and paste it in a browser manually.</p><h2 id=step-3-create-a-cloudflare-tunnel>Step 3: Create a Cloudflare Tunnel<a href=#step-3-create-a-cloudflare-tunnel class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Now, we are ready to create a Cloudflare Tunnel that will connect <code>cloudflared</code> to Cloudflare&rsquo;s edge. Running the following command will create a Tunnel with tht name and generate an ID credentials file for it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cloudflared tunnel create $NAME
</span></span></code></pre></div><p>Once the Tunnel is created, a credential file is generated. It&rsquo;s a JSON file that has the Universally Unique Identifier (UUID) assigned for the Tunnel.</p><p><em>Note: although the Tunnel is created, the connection is not established yet.</em></p><h2 id=step-4-configure-the-tunnel-details>Step 4: Configure the Tunnel details<a href=#step-4-configure-the-tunnel-details class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Cloudflare utilizes a configuration file to determine how to route traffic. The configuration file contains keys and values, which is written in YAML syntax. You may need to modify the following keys and values to meet your configuration file requirements. By default, on Linux systems, Tunnel expects to find the configuration file in <code>~/.cloudflared</code>, <code>/etc/cloudflared</code> and <code>/usr/local/etc/cloudflared</code> in that order.
Let&rsquo;s create our config file and save in the default expected directory for this tutorial.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano ~/.cloudflared/config.yml
</span></span></code></pre></div><p>Then, we will paste our keys and values as shown below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown><span style=display:flex><span>tunnel: 1082b601-bce9-45e4-b6ae-f19020e7d071
</span></span><span style=display:flex><span>credentials-file: /root/.cloudflared/1082b601-bce9-45e4-b6ae-f19020e7d071.json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ingress:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>-</span> hostname: test.mytunnel.ml
</span></span><span style=display:flex><span>    service: http://localhost:80
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>-</span> service: http_status:404
</span></span></code></pre></div><h2 id=step-5-create-dns-records-to-route-traffic-to-the-tunnel>Step 5: Create DNS records to route traffic to the Tunnel<a href=#step-5-create-dns-records-to-route-traffic-to-the-tunnel class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Run the following command from the command line. This command will generate a CNAME record that points to the subdomain of a specific Tunnel. The result is the same as creating a CNAME record from the dashboard.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cloudflared tunnel route dns $NAME $HOSTNAME
</span></span></code></pre></div><p><em>Note: unlike the previous Argo Tunnel architecture, this DNS record will not be deleted if the Tunnel disconnects.</em></p><h2 id=step-6-run-and-manage-the-tunnel>Step 6: Run and manage the Tunnel<a href=#step-6-run-and-manage-the-tunnel class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The <code>run</code> command will connect cloudflared to Cloudflare&rsquo;s edge network using the configuration created in step 4. We will not specify a configuration file location so Cloudflared retrieves it from the default location, which is <code>~/.cloudflared/config.yml</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cloudflared tunnel run $NAME
</span></span></code></pre></div><h2 id=step-7-run-tunnel-as-a-service>Step 7: Run Tunnel as a service<a href=#step-7-run-tunnel-as-a-service class=hanchor arialabel=Anchor>&#8983;</a></h2><p>By running the following command, the tunnel can be installed as a system service which allows the tunnel to run at boot automatically as launch daemon. By default, the tunnel expects to find the configuration file in the default directory, <code>~/.cloudflared/config.yml</code> but to run tunnel as a service, we might need to move the <code>config.yml</code> file to <code>/etc/cloudflared/</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mkdir -p /etc/cloudflared/
</span></span><span style=display:flex><span>sudo mv ~/.cloudflared/config.yml /etc/cloudflared/
</span></span></code></pre></div><p>Now, we are ready to run Tunnel as a service utilizing the command below</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cloudflared service install 
</span></span></code></pre></div><h2 id=step-8-add-more-services-optional>Step 8: Add more services (optional)<a href=#step-8-add-more-services-optional class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Pair another hostname:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cloudflared tunnel route dns &lt;UUID or NAME&gt; demo2.example.com
</span></span></code></pre></div><p>Add another ingress point to the config:</p><pre tabindex=0><code>ingress:
  - hostname: demo.example.com
    service: http://localhost:80
  - hostname: demo2.example.com
    service: http://localhost:8080
  - service: http_status:404
</code></pre><p>Re-install the previous config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cloudflared service uninstall
</span></span><span style=display:flex><span>sudo cloudflared service install
</span></span></code></pre></div><p>Restart service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart cloudflared
</span></span></code></pre></div><h1 id=references>References<a href=#references class=hanchor arialabel=Anchor>&#8983;</a></h1><ol><li><a href=https://dev.to/omarcloud20/a-free-cloudflare-tunnel-running-on-a-raspberry-pi-1jid>https://dev.to/omarcloud20/a-free-cloudflare-tunnel-running-on-a-raspberry-pi-1jid</a></li><li><a href=https://cyberhost.uk/cloudflare-argo-tunnel>https://cyberhost.uk/cloudflare-argo-tunnel</a></li></ol></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div></body></html>