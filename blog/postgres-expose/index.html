<!doctype html><html lang=en><head><title>Create a PostgreSQL server and expose it remotely using Lets Encrypt :: Somnath Rakshit</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I have been trying for some days to create a PostgreSQL server and expose it on the web so that it can be accessed by external clients. This is useful to me for hosting several personal projects that require a database.
First things first, let&amp;rsquo;s create our env variables.
HOSTNAME=&amp;#34;subdomain.domain.tld&amp;#34; # Hostname of your server EMAIL=&amp;#34;email@email.com&amp;#34; # Used for Let&amp;#39;s Encrypt certificate VERSION=&amp;#34;14&amp;#34; # PostgreSQL version NAME=&amp;#34;db&amp;#34; # Database name Let&amp;rsquo;s update our packages now."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/blog/postgres-expose/><link rel=stylesheet href=/assets/style.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Create a PostgreSQL server and expose it remotely using Lets Encrypt"><meta property="og:description" content="I have been trying for some days to create a PostgreSQL server and expose it on the web so that it can be accessed by external clients. This is useful to me for hosting several personal projects that require a database.
First things first, let&amp;rsquo;s create our env variables.
HOSTNAME=&amp;#34;subdomain.domain.tld&amp;#34; # Hostname of your server EMAIL=&amp;#34;email@email.com&amp;#34; # Used for Let&amp;#39;s Encrypt certificate VERSION=&amp;#34;14&amp;#34; # PostgreSQL version NAME=&amp;#34;db&amp;#34; # Database name Let&amp;rsquo;s update our packages now."><meta property="og:url" content="/blog/postgres-expose/"><meta property="og:site_name" content="Somnath Rakshit"><meta property="og:image" content="/img/favicon/orange.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-09-04 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Somnath Rakshit</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/blog>Blog</a></li><li><a href=/contact>Contact</a></li><li><a href=/projects>Projects</a></li><li><a href=/files/somnathrakshit_resume.pdf>Resume</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/blog>Blog</a></li><li><a href=/contact>Contact</a></li><li><a href=/projects>Projects</a></li><li><a href=/files/somnathrakshit_resume.pdf>Resume</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/blog/postgres-expose/>Create a PostgreSQL server and expose it remotely using Lets Encrypt</a></h1><div class=post-meta><span class=post-date>2022-09-04</span></div><div class=post-content><div><p>I have been trying for some days to create a PostgreSQL server and expose it on the web so that it can be accessed by external clients. This is useful to me for hosting several personal projects that require a database.</p><p>First things first, let&rsquo;s create our env variables.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>HOSTNAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;subdomain.domain.tld&#34;</span> <span style=color:#75715e># Hostname of your server</span>
</span></span><span style=display:flex><span>EMAIL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;email@email.com&#34;</span> <span style=color:#75715e># Used for Let&#39;s Encrypt certificate</span>
</span></span><span style=display:flex><span>VERSION<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;14&#34;</span> <span style=color:#75715e># PostgreSQL version</span>
</span></span><span style=display:flex><span>NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;db&#34;</span> <span style=color:#75715e># Database name</span>
</span></span></code></pre></div><p>Let&rsquo;s update our packages now.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install postgresql
</span></span></code></pre></div><p>Now, we will use <code>nano</code> to edit PostgreSQL config file and set <code>listen_addresses = '*'</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/postgresql/$VERSION/main/postgresql.conf
</span></span><span style=display:flex><span><span style=color:#75715e># In this file, add the following line somewhere under the &#34;CONNECTIONS AND AUTHENTICATION&#34; section. </span>
</span></span><span style=display:flex><span><span style=color:#75715e># This will instruct PostgreSQL to listen on all network interfaces for incoming connections.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># listen_addresses = &#39;*&#39;</span>
</span></span></code></pre></div><p>Now, restart PostgreSQL for the config changes to take place. Then, add firewall configs as below. This will make your server reachable from anywhere (<code>0.0.0.0/0</code>) and opens ports <code>5432</code> and <code>80</code> to accept incoming traffic. You need to open port <code>80</code> in order to set up SSL certificates with Let&rsquo;s Encrypt.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart postgresql
</span></span><span style=display:flex><span>sudo bash -c <span style=color:#e6db74>&#34;echo host    all          all            0.0.0.0/0  md5 &gt;&gt; /etc/postgresql/&#34;</span>$VERSION<span style=color:#e6db74>&#34;4/main/pg_hba.conf&#34;</span>
</span></span><span style=display:flex><span>sudo iptables -I INPUT <span style=color:#ae81ff>6</span> -m state --state NEW -p tcp --dport <span style=color:#ae81ff>5432</span> -j ACCEPT
</span></span><span style=display:flex><span>sudo iptables -I INPUT <span style=color:#ae81ff>6</span> -m state --state NEW -p tcp --dport <span style=color:#ae81ff>80</span> -j ACCEPT
</span></span><span style=display:flex><span>sudo netfilter-persistent save
</span></span></code></pre></div><p>Let us now set up SSL certificates using Let&rsquo;s Encrypt. This will also accept their terms and conditions automatically.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-cache policy certbot
</span></span><span style=display:flex><span>sudo apt-get -y install certbot
</span></span><span style=display:flex><span>sudo certbot certonly --standalone -d $HOSTNAME --staple-ocsp -m $EMAIL --agree-tos
</span></span></code></pre></div><p>Having set up our SSL certificates, we now need to instruct PostgreSQL to use them to transfer data securely instead of transferring data without encryption. Edit the configuration file at <code>/etc/postgresql/$VERSION/main/postgresql.conf</code>, where $VERSION is your Postgres version (mine is 14). Find the SSL section, then edit it to enable SSL and specify the locations of the certificate and key.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown><span style=display:flex><span>ssl = on
</span></span><span style=display:flex><span>ssl_cert_file = &#39;/etc/postgresql/$VERSION/main/fullchain.pem&#39;
</span></span><span style=display:flex><span>ssl_key_file = &#39;/etc/postgresql/$VERSION/main/privkey.pem&#39;
</span></span></code></pre></div><p>Now, copy the certificate files from their original location to the one that you just mentioned.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp /etc/letsencrypt/live/$HOSTNAME/fullchain.pem /etc/postgresql/$VERSION/main/fullchain.pem
</span></span><span style=display:flex><span>sudo cp /etc/letsencrypt/live/$HOSTNAME/privkey.pem /etc/postgresql/$VERSION/main/privkey.pem
</span></span><span style=display:flex><span>sudo chmod <span style=color:#ae81ff>600</span> /etc/postgresql/$VERSION/main/fullchain.pem /etc/postgresql/$VERSION/main/privkey.pem
</span></span><span style=display:flex><span>sudo chown postgres:postgres /etc/postgresql/$VERSION/main/fullchain.pem /etc/postgresql/$VERSION/main/privkey.pem
</span></span><span style=display:flex><span>sudo systemctl restart postgresql
</span></span></code></pre></div><p>Remember that these SSL certificates are valid for 90 days and should be updated every 60 days. One way of automating this process is by using <code>cron</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>crontab -e
</span></span></code></pre></div><p>Now go to the last line and paste the text given below. Make sure to replace $HOSTNAME and $VERSION with their actual values before saving. This command may look messy but it gets the job done.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown><span style=display:flex><span>02  08  <span style=font-style:italic>*   *</span>   *   /opt/certbot/bin/certbot renew --post-hook &#34;sudo cp /etc/letsencrypt/live/$HOSTNAME/fullchain.pem /etc/postgresql/$VERSION/main/fullchain.pem <span style=color:#960050;background-color:#1e0010>&amp;&amp;</span> sudo cp /etc/letsencrypt/live/$HOSTNAME/privkey.pem /etc/postgresql/$VERSION/main/privkey.pem <span style=color:#960050;background-color:#1e0010>&amp;&amp;</span> sudo chmod 600 /etc/postgresql/$VERSION/main/fullchain.pem /etc/postgresql/$VERSION/main/privkey.pem <span style=color:#960050;background-color:#1e0010>&amp;&amp;</span> sudo chown postgres:postgres /etc/postgresql/$VERSION/main/fullchain.pem /etc/postgresql/$VERSION/main/privkey.pem <span style=color:#960050;background-color:#1e0010>&amp;&amp;</span> sudo systemctl restart postgresql&#34; --quiet
</span></span></code></pre></div><p>That&rsquo;s it, we should be able to create test database now.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo -u postgres psql
</span></span></code></pre></div><p>Within the SQL prompt, use the following query to create a database now. Make sure that you use a long (more than 20 characters with uppercase, lowercase, digits, and special characters included) and strong password since your database is exposed to the public and is vulnerable against attacks.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>database</span> mydb;
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>user</span> myuser <span style=color:#66d9ef>with</span> <span style=color:#66d9ef>encrypted</span> password <span style=color:#e6db74>&#39;mypass&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>grant</span> <span style=color:#66d9ef>all</span> <span style=color:#66d9ef>privileges</span> <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>database</span> mydb <span style=color:#66d9ef>to</span> myuser;
</span></span></code></pre></div><p>Let us reboot our server now to make sure everything works well.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo reboot
</span></span></code></pre></div><p>To verify if your connections are using SSL, run the following SQL query.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> ssl.pid, usename, datname, ssl, ssl.<span style=color:#66d9ef>version</span>, ssl.cipher, ssl.bits, client_addr
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> pg_catalog.pg_stat_ssl ssl, pg_catalog.pg_stat_activity activity
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> ssl.pid <span style=color:#f92672>=</span> activity.pid
</span></span><span style=display:flex><span><span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><p>That&rsquo;s it! You can now run your own PostgreSQL instance on the web.</p><h2 id=references>References<a href=#references class=hanchor arialabel=Anchor>&#8983;</a></h2><ol><li><a href=https://linuxconfig.org/ubuntu-22-04-postgresql-installation>https://linuxconfig.org/ubuntu-22-04-postgresql-installation</a></li><li><a href=https://www.learnitguide.net/2022/04/install-certbot-on-ubuntu.html>https://www.learnitguide.net/2022/04/install-certbot-on-ubuntu.html</a></li><li><a href=https://docs.min.io/docs/generate-let-s-encypt-certificate-using-concert-for-minio.html>https://docs.min.io/docs/generate-let-s-encypt-certificate-using-concert-for-minio.html</a></li><li><a href=https://loganmarchione.com/2020/10/securing-postgres-connections-using-lets-encrypt-certificates/>https://loganmarchione.com/2020/10/securing-postgres-connections-using-lets-encrypt-certificates/</a></li><li><a href=https://medium.com/coding-blocks/creating-user-database-and-adding-access-on-postgresql-8bfcd2f4a91e>https://medium.com/coding-blocks/creating-user-database-and-adding-access-on-postgresql-8bfcd2f4a91e</a></li></ol><p>All commands are available on this Github Gist.</p><script src=https://gist.github.com/somnathrakshit/4d4cd4c19f13013075164490dc4b6827.js></script></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div></body></html>